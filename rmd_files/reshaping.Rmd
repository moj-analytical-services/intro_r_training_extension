# Reshaping data


The tidyr package can help us to reshape dataframes - this can be really helpful when we need to transform between tables that are easier to read and tables that are easier to analyse. For example, we might need to structure a dataset so that it can be manipulated more easily at a later stage of the analysis.

These situations may arise when there is more than one category associated with each value in a dataset. The dataset can be **lengthened** or **widened** (increasing the number of rows or columns, respectively), and this process is commonly referred to as **pivoting**.


## Transforming from wide to long format

Let's take a look at the `billboard` dataset supplied with tidyr (it should be available when you load the package), which contains the rank of songs in the year 2000. The dataset has 79 columns (one for each week, starting from Oct 1999, along with the artist, track name, and release date) and 317 rows.

```{r, purl=purl_example_code}
# Preview the data
billboard %>% head(10)
```

We can use the `pivot_longer()` function to help restructure this dataframe by decreasing the number of columns while increasing the number of rows. For example, we can map the first four week columns into a pair of new variables, called `month1` and `rank`.


```{r, purl=purl_example_code}
# Start by mapping a single month 
billboard_longer <- billboard %>%
  tidyr::pivot_longer(cols = c(wk1,wk2, wk3, wk4), names_to = "week_of_month1", values_to = "rank") %>% head()

# Display what we've done
billboard_longer %>% dplyr::select(artist, track, date.entered, week_of_month1, rank)
```

In the `pivot_longer()` function, we've specified variables/columns to be **gathered** into a new pair of columns using the `cols()` argument, then the `names_to` argument specifies the name of a new column to contain the names of the gathered columns, and `values_to` specifies the name of a new column to contain the corresponding values.  



## Transforming from long to wide format

The `pivot_wider()` function is the inverse of `pivot_longer()`, and transforms a dataframe to a **wider** format, with more columns and fewer rows. This wider format is often preferrable for displaying data, as it easier for a person to look at and interpret.

Consider the `fish_encounters` dataset, which contains a record of fish that are detected by various monitoring stations.

```{r, purl=purl_example_code}
fish_encounters %>% head(10)
```

We can use the `pivot_wider()` function to restructure this dataframe into a wide format: 

```{r, purl=purl_example_code}
fish_encounters %>% tidyr::pivot_wider(names_from = station, values_from = seen)
```

The `names_from` argument is used to specify the column containing categories we want to split across multiple columns, and the `values_from` argument contains the corresponding values for each category. 

In this dataframe there are some combinations of `fish` and `station` that don't exist in the original data, therefore the `values_fill` argument can be used to specify a value for these. In this case we've chosen to fill the NA values with zero:

```{r, purl=purl_example_code}
fish_encounters %>% tidyr::pivot_wider(names_from = station, values_from = seen, values_fill = list(seen = 0))
```


### Aggregating with `pivot_wider`

Consider the `warpbreaks` dataset, which describes the results of a designed experiment with nine replicates for every combination of wool (A and B) and tension (L, M, H). 

```{r, purl=purl_example_code}
warpbreaks %>% dplyr::select(wool, tension, breaks)
```

Note the warning that appears when trying to widen this dataset. This is because some combinations of `wool` and `tension` are repeated several times. 

```{r, purl=purl_example_code}
warpbreaks %>% tidyr::pivot_wider(names_from = wool, values_from = breaks)
```

To deal with this issue, we can use the optional `values_fn` argument in the `pivot_wider()` function, which allows us to specify a function to use to aggregate the multiple values. For example, we can specify to calculate the mean number of breaks for each combination of `wool` and `tension` like so:

```{r, purl=purl_example_code}
warpbreaks %>%
  tidyr::pivot_wider(
    names_from = wool,
    values_from = breaks,
    values_fn = list(breaks = mean)
  )
```


## Exercises 

#### Exercise 1 

Why does the following code fail?

```{r, purl=purl_example_code}
#the table to use
table4a
```

```{r, purl=purl_example_code, eval=F}
table4a %>% tidyr::pivot_longer(1999, 2000, names_to = "year", values_to = "value")
```


#### Exercise 2

Consider the following dataset and apply `pivot_wider()` to **spread** the values in `name`, do you agree with the results after pivoting? 

Hint. Could a new column solve the problem, what other solution could we apply?

```{r, purl=purl_example_code}
people = tribble(~name, ~key, ~value,
                 "Phil Woods", "age",45,
                 "Phil Woods", "height",185,
                 "Phil Woods", "age",50,
                 "Jess Cordero", "age",45,
                 "Jess Cordero", "height",156,)
```


#### Exercise 3

Consider the followign simple tibble, what kind of pivoting would you use, `pivot_longer()` or `pivot_wider()` ?

```{r, purl=purl_example_code}
rcj = tribble( ~judge, ~male, ~female,
                    "yes", NA, 10, 
                    "no", 20, 12)
```


```{r, include=show_solution, purl=purl_solutions}
# Exercise 1 solution
table4a %>% tidyr::pivot_longer(cols = !country, names_to = "year",values_to = "value")
```


```{r, include=show_solution, purl=purl_solutions}
# Exercise 2 solution

# Without changing anything on the dataset
people = tribble(~name, ~key, ~value,
                 "Phil Woods", "age",45,
                 "Phil Woods", "height",185,
                 "Phil Woods", "age",50,
                 "Jess Cordero", "age",45,
                 "Jess Cordero", "height",156,)
people %>% tidyr::pivot_wider(names_from = name, values_from = value)

# Solution 1 - adding a new column
people = tribble(~name, ~key, ~value, ~dkey,
                 "Phil Woods", "age",45,1,
                 "Phil Woods", "height",185,1,
                 "Phil Woods", "age",50,0,
                 "Jess Cordero", "age",45,1,
                 "Jess Cordero", "height",156,1)

people %>% tidyr::pivot_wider(names_from = name, values_from = value)

# Solution 2  - uniqueness
people = tribble(~name, ~key, ~value,
                 "Phil Woods", "age",45,
                 "Phil Woods", "height",185,
                 # "Phil Woods", "age",50,
                 "Jess Cordero", "age",45,
                 "Jess Cordero", "height",156,)

people %>% tidyr::pivot_wider(names_from = name, values_from = value)
```



```{r, include=show_solution, purl=purl_solutions}
# Exercise 3 solution

rcj = tribble( ~judge, ~male, ~female,
                    "yes", NA, 10, 
                    "no", 20, 12)

#use of pivot_longer
rcj %>% tidyr::pivot_longer(cols = c(male, female), names_to = "gender", values_to = "count")

# use of  pivot_wider 
rcj %>% tidyr::pivot_wider(names_from = judge, values_from = c(male, female))
```

